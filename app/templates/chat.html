{% include "base.html" %}

{% block content %}

<script type="text/javascript" src="//cdn.socket.io/4.4.1/socket.io.min.js"></script>
<script type="text/javascript" src="//code.jquery.com/jquery-1.4.2.min.js"></script>

<style>
    /* Custom styles */
    #chat-messages {
        height: 70vh;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        align-items: flex-end;
    }

    .message {
        padding: 5px 10px;
        margin: 5px;
        border-radius: 10px;
        max-width: 70%;
        word-wrap: break-word;
    }

    .incoming-message {
        background-color: #f0f0f0;
        align-self: flex-start;
        color: black;
    }

    .outgoing-message {
        background-color: #007bff;
        color: #fff;
        align-self: flex-end;
    }

    .message-sender {
        font-weight: bold;
        margin-bottom: 2px;
    }

    .message-timestamp {
        font-size: 0.8rem;
        color: #bfbfbf;
    }
</style>





<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">Chat</div>
                <div class="card-body">
                    <div id="chat-messages" class="mb-3 ">
                        <!-- Chat messages will be displayed here -->
                        <div class="message incoming-message">
                            <div class="message-sender">John</div>
                            <div>Hello!</div>
                            <div class="message-timestamp">15 March 2024, 10:30 AM</div>
                        </div>
                        <div class="message outgoing-message">
                            <div class="message-sender">You</div>
                            <div>Hi there!</div>
                            <div class="message-timestamp">15 March 2024, 10:32 AM</div>
                        </div>
                        <!-- Sample messages -->
                    </div>
                    <div class="input-group">
                        <input type="text" class="form-control" placeholder="Type your message here...">
                        <div class="input-group-append">
                            <button id="send-button" class="btn btn-primary" type="button">Send</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>

    const sendButton = document.getElementById('send-button');

    const username = "{{ username }}"
    const roomid = "{{ roomid }}"
    const user_id = "{{ user_id }}"

    function createMessage(message, sender, timestamp, isOutgoing) {
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('message');
        messageDiv.classList.add(isOutgoing ? 'outgoing-message' : 'incoming-message');

        const senderDiv = document.createElement('div');
        senderDiv.classList.add('message-sender');
        senderDiv.innerText = sender;

        const messageContentDiv = document.createElement('div');
        messageContentDiv.innerText = message;

        const timestampDiv = document.createElement('div');
        timestampDiv.classList.add('message-timestamp');
        timestampDiv.innerText = timestamp;

        messageDiv.appendChild(senderDiv);
        messageDiv.appendChild(messageContentDiv);
        messageDiv.appendChild(timestampDiv);

        return messageDiv;
    }

    function addMessageToChat(message, sender, timestamp, isOutgoing) {
        const chatMessagesDiv = document.getElementById('chat-messages');
        const messageDiv = createMessage(message, sender, timestamp, isOutgoing);
        chatMessagesDiv.appendChild(messageDiv);
        chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
    }

    document.addEventListener('DOMContentLoaded', () => {
        const chatForm = document.querySelector('.card-body .input-group');
        const chatInput = chatForm.querySelector('input');
        const chatSendButton = chatForm.querySelector('button');

        chatForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const message = chatInput.value;
            chatInput.value = '';
            addMessageToChat(message, 'You', new Date().toLocaleString(), true);
        });

        // Sample incoming message
        addMessageToChat('Hello!', 'John', '15 March 2024, 10:30 AM', false);
    });

    

</script>

<script>
    var socket;

    $(document).ready(()=>{
        socket = io.connect('http://' + document.domain + ':' + location.port + '/chat');

        socket.on('connect', ()=>{
            console.log("connected");
            socket.emit('join_room', {
                username: username,
                roomid: roomid
            });
        });

        socket.on('message', (data)=>{
            console.log(data.user_id);
            console.log(user_id);
            addMessageToChat(data.message, data.username, new Date().toLocaleString(), parseInt(data.user_id) === parseInt(user_id) ? true : false);
        });

        sendButton.addEventListener('click', () => {
        const message = document.querySelector('.input-group input').value;
        socket.emit('send_message', {
            message: message
        });
    });

        
    })

</script>

{% endblock %}